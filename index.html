<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firmung – Cinematic Experience</title>
    <meta name="description" content="Erlebe die Firmungsfeier in einer einzigartigen cineastischen Galerie">
    <link rel="preconnect" href="https://api.github.com">
    <style>
        :root {
            --primary-gold: #f2d78a;
            --dark-gold: #b89443;
            --bg-dark: #050505;
            --text-light: #fff;
            --blur-intensity: 2px;
            --shadow-color: rgba(0,0,0,0.7);
            --glow-color: rgba(230,195,106,0.7);
        }

        * {
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--text-light);
            cursor: none;
        }

        /* ==================== Loading Screen ==================== */
        #loading {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--bg-dark);
            z-index: 1000;
            transition: opacity 0.8s ease-out;
        }

        #loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(242, 215, 138, 0.3);
            border-top: 3px solid var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            opacity: 0.8;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ==================== Custom Cursor ==================== */
        #cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, var(--primary-gold), transparent);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transition: transform 0.1s ease;
            opacity: 0;
        }

        #cursor.active {
            opacity: 1;
        }

        /* ==================== Intro Layer ==================== */
        #intro {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background: linear-gradient(45deg, transparent, rgba(242, 215, 138, 0.05), transparent);
        }

        #intro h1 {
            font-size: clamp(3rem, 8vw, 6rem);
            margin-bottom: 0.5em;
            opacity: 0;
            background: linear-gradient(45deg, var(--primary-gold), var(--dark-gold));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: introText 2s forwards;
            font-weight: 300;
            letter-spacing: 2px;
            text-shadow: 0 0 30px var(--glow-color);
        }

        #intro p {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            opacity: 0;
            animation: introText 2s forwards;
            animation-delay: 0.7s;
            font-weight: 300;
            letter-spacing: 1px;
        }

        #intro .subtitle {
            font-size: clamp(0.9rem, 2vw, 1.2rem);
            opacity: 0;
            animation: introText 2s forwards;
            animation-delay: 1.2s;
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        @keyframes introText {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
                filter: blur(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        /* ==================== Motion Layers ==================== */
        .layer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 30px;
            will-change: transform;
            filter: drop-shadow(0 20px 40px var(--shadow-color));
        }

        .layer img {
            height: clamp(200px, 25vh, 300px);
            width: auto;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            object-fit: cover;
            aspect-ratio: 4/3;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .layer img:hover {
            transform: scale(1.1) translateY(-10px);
            filter: brightness(1.1) contrast(1.1) drop-shadow(0 30px 60px rgba(242, 215, 138, 0.3));
            z-index: 5;
            position: relative;
        }

        .layer img.loading {
            opacity: 0.3;
            filter: blur(2px);
        }

        .layer img.loaded {
            opacity: 1;
            filter: blur(0);
        }

        /* Layer-specific animations */
        .back {
            animation: drift 300s linear infinite;
            opacity: 0.2;
            filter: blur(var(--blur-intensity));
        }

        .mid {
            animation: drift 180s linear infinite reverse;
            opacity: 0.6;
            filter: blur(1px);
        }

        .front {
            animation: drift 120s linear infinite;
            opacity: 1;
        }

        @keyframes drift {
            from { transform: translate(-50%, -50%) translateX(-100vw); }
            to { transform: translate(-50%, -50%) translateX(100vw); }
        }

        /* ==================== Image Viewer ==================== */
        #viewer {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        #viewer.active {
            display: flex;
        }

        #viewer img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            animation: zoomIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            cursor: zoom-out;
        }

        .viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .viewer-close:hover {
            background: var(--primary-gold);
            color: var(--bg-dark);
            transform: scale(1.1);
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.5);
                opacity: 0;
                filter: blur(10px);
            }
            to {
                transform: scale(1);
                opacity: 1;
                filter: blur(0);
            }
        }

        /* ==================== CTA Button ==================== */
        #cta {
            position: fixed;
            bottom: 8%;
            left: 50%;
            transform: translateX(-50%);
            padding: 25px 80px;
            border-radius: 50px;
            background: linear-gradient(135deg, var(--primary-gold), var(--dark-gold));
            color: var(--bg-dark);
            font-size: 1.6rem;
            font-weight: 600;
            text-decoration: none;
            box-shadow: 0 0 50px var(--glow-color);
            animation: pulse 3s infinite;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            border: none;
            z-index: 50;
        }

        #cta:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 0 80px var(--glow-color);
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.02); }
        }

        /* ==================== Error Messages ==================== */
        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ==================== Floating Animation ==================== */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .layer img {
            animation: float 8s ease-in-out infinite;
        }

        .layer img:nth-child(2n) {
            animation-delay: -2s;
        }

        .layer img:nth-child(3n) {
            animation-delay: -4s;
        }

        /* ==================== Responsive Design ==================== */
        @media (max-width: 768px) {
            .layer {
                gap: 15px;
            }
            
            .layer img {
                height: clamp(150px, 20vh, 200px);
            }
            
            #cta {
                padding: 20px 60px;
                font-size: 1.3rem;
                bottom: 5%;
            }
            
            #viewer img {
                max-width: 95%;
                max-height: 95%;
            }
            
            body {
                cursor: auto;
            }
            
            #cursor {
                display: none;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ==================== Accessibility ==================== */
        @media (prefers-contrast: high) {
            :root {
                --primary-gold: #fff700;
                --dark-gold: #b8860b;
                --text-light: #ffffff;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Lade Erinnerungen...</div>
    </div>

    <!-- Custom Cursor -->
    <div id="cursor"></div>

    <!-- Intro Screen -->
    <div id="intro">
        <h1>Firmung</h1>
        <p>Ein Moment für die Erinnerung</p>
        <div class="subtitle">Bewege die Maus für eine cineastische Erfahrung</div>
    </div>

    <!-- Image Layers -->
    <div class="layer back" id="back" role="img" aria-label="Hintergrundbilder der Firmung"></div>
    <div class="layer mid" id="mid" role="img" aria-label="Hauptbilder der Firmung"></div>
    <div class="layer front" id="front" role="img" aria-label="Vordergrundbilder der Firmung"></div>

    <!-- Image Viewer -->
    <div id="viewer" role="dialog" aria-modal="true" aria-label="Bildvorschau">
        <div class="viewer-close" onclick="closeViewer()" aria-label="Schließen">&times;</div>
        <img id="viewerImg" alt="Vergrößerte Ansicht">
    </div>

    <!-- CTA Button -->
    <a id="cta" href="#" target="_blank" rel="noopener" role="button" aria-label="Alle Bilder herunterladen">
        <span class="sr-only">Alle Bilder der Firmung </span>Alle Bilder herunterladen
    </a>

    <script>
        class FirmungGallery {
            constructor() {
                this.config = {
                    user: "Elias3422",
                    repo: "Firmung-",
                    path: "bilder",
                    maxRetries: 3,
                    retryDelay: 1000,
                    imageFormats: /\.(jpg|jpeg|png|webp|gif)$/i
                };
                
                this.state = {
                    images: [],
                    loadedImages: 0,
                    totalImages: 0,
                    isLoading: true,
                    hasError: false
                };

                this.elements = {};
                this.observers = {};
                this.rafId = null;
                this.mousePosition = { x: 0, y: 0 };
                
                this.init();
            }

            async init() {
                try {
                    this.cacheElements();
                    this.setupEventListeners();
                    this.setupIntersectionObserver();
                    this.initCustomCursor();
                    
                    await this.loadImages();
                    this.startExperience();
                } catch (error) {
                    this.handleError('Initialisierung fehlgeschlagen', error);
                }
            }

            cacheElements() {
                const elements = ['loading', 'intro', 'back', 'mid', 'front', 'viewer', 'viewerImg', 'cursor', 'cta'];
                elements.forEach(id => {
                    this.elements[id] = document.getElementById(id);
                });
            }

            setupEventListeners() {
                // Keyboard navigation
                document.addEventListener('keydown', this.handleKeydown.bind(this));
                
                // Mouse movement with throttling
                document.addEventListener('mousemove', this.throttle(this.handleMouseMove.bind(this), 16));
                
                // Device orientation for mobile
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', this.handleDeviceOrientation.bind(this));
                }

                // Viewport change handling
                window.addEventListener('resize', this.throttle(this.handleResize.bind(this), 250));
                
                // Visibility change
                document.addEventListener('visibilitychange', this.handleVisibilityChange.bind(this));

                // Error handling
                window.addEventListener('error', this.handleGlobalError.bind(this));
            }

            setupIntersectionObserver() {
                this.observers.images = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            this.lazyLoadImage(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
            }

            initCustomCursor() {
                if (window.innerWidth > 768) {
                    this.elements.cursor.classList.add('active');
                }
            }

            async loadImages() {
                const api = `https://api.github.com/repos/${this.config.user}/${this.config.repo}/contents/${this.config.path}`;
                
                try {
                    const response = await this.fetchWithRetry(api);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const files = await response.json();
                    
                    if (!Array.isArray(files)) {
                        throw new Error('Ungültige API-Antwort erhalten');
                    }

                    this.state.images = files
                        .filter(file => this.config.imageFormats.test(file.name))
                        .map(file => ({
                            url: file.download_url,
                            name: file.name,
                            loaded: false
                        }));

                    this.state.totalImages = this.state.images.length;

                    if (this.state.images.length === 0) {
                        throw new Error('Keine Bilder gefunden');
                    }

                    this.distributeImages();
                    this.updateCTALink();

                } catch (error) {
                    this.handleError('Fehler beim Laden der Bilder', error);
                    throw error;
                }
            }

            async fetchWithRetry(url, retries = this.config.maxRetries) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, {
                            headers: {
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        return response;
                    } catch (error) {
                        if (i === retries - 1) throw error;
                        await this.delay(this.config.retryDelay * (i + 1));
                    }
                }
            }

            distributeImages() {
                const layers = ['back', 'mid', 'front'];
                const steps = [4, 3, 2];

                layers.forEach((layerId, index) => {
                    this.fillLayer(layerId, this.state.images, steps[index]);
                });
            }

            fillLayer(layerId, images, step) {
                const layer = this.elements[layerId];
                const duplicatedImages = [...images, ...images, ...images]; // Triple for seamless loop
                
                duplicatedImages.forEach((imageData, i) => {
                    if (i % step !== 0) return;

                    const img = this.createImageElement(imageData, layerId);
                    layer.appendChild(img);
                });
            }

            createImageElement(imageData, layerId) {
                const img = document.createElement('img');
                img.className = 'loading';
                img.alt = `Firmungsbild: ${imageData.name}`;
                img.loading = 'lazy';
                img.decoding = 'async';
                
                // Add click handler
                img.addEventListener('click', () => this.openViewer(imageData.url, imageData.name));
                
                // Add to intersection observer for lazy loading
                this.observers.images.observe(img);
                
                // Store image data
                img.dataset.src = imageData.url;
                img.dataset.layer = layerId;

                return img;
            }

            lazyLoadImage(img) {
                if (img.dataset.loaded === 'true') return;

                const imageUrl = img.dataset.src;
                
                // Create a new image to preload
                const preloadImg = new Image();
                preloadImg.onload = () => {
                    img.src = imageUrl;
                    img.classList.remove('loading');
                    img.classList.add('loaded');
                    img.dataset.loaded = 'true';
                    this.state.loadedImages++;
                    this.updateLoadingProgress();
                };
                
                preloadImg.onerror = () => {
                    img.style.display = 'none';
                    console.warn(`Fehler beim Laden des Bildes: ${imageUrl}`);
                };

                preloadImg.src = imageUrl;
                
                // Remove from observer
                this.observers.images.unobserve(img);
            }

            updateLoadingProgress() {
                const progress = (this.state.loadedImages / this.state.totalImages) * 100;
                
                if (progress >= 30 && this.state.isLoading) {
                    // Start experience when 30% loaded
                    this.startExperience();
                }
            }

            startExperience() {
                if (!this.state.isLoading) return;
                
                this.state.isLoading = false;
                
                // Hide loading screen
                this.elements.loading.classList.add('hidden');
                
                // Start intro sequence
                setTimeout(() => {
                    this.elements.intro.style.opacity = '0';
                    setTimeout(() => {
                        this.elements.intro.style.display = 'none';
                        this.startParallaxAnimation();
                    }, 1000);
                }, 4000);
            }

            startParallaxAnimation() {
                const animate = () => {
                    this.updateParallax();
                    this.rafId = requestAnimationFrame(animate);
                };
                animate();
            }

            handleMouseMove(e) {
                this.mousePosition.x = e.clientX;
                this.mousePosition.y = e.clientY;
                
                // Update custom cursor
                if (this.elements.cursor.classList.contains('active')) {
                    this.elements.cursor.style.left = e.clientX + 'px';
                    this.elements.cursor.style.top = e.clientY + 'px';
                }
            }

            updateParallax() {
                const { x, y } = this.mousePosition;
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                const offsetX = (x - centerX) / centerX;
                const offsetY = (y - centerY) / centerY;
                
                const layers = [
                    { element: this.elements.front, multiplier: 40 },
                    { element: this.elements.mid, multiplier: 20 },
                    { element: this.elements.back, multiplier: 10 }
                ];

                layers.forEach(({ element, multiplier }) => {
                    const translateX = offsetX * multiplier;
                    const translateY = offsetY * multiplier * 0.5;
                    
                    element.style.transform = `translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px))`;
                });
            }

            handleDeviceOrientation(e) {
                if (window.innerWidth <= 768) {
                    const gamma = (e.gamma || 0) * 0.3;
                    const beta = (e.beta || 0) * 0.1;
                    
                    this.elements.front.style.transform = `translate(calc(-50% + ${gamma}px), calc(-50% + ${beta}px))`;
                    this.elements.mid.style.transform = `translate(calc(-50% + ${gamma/2}px), calc(-50% + ${beta/2}px))`;
                    this.elements.back.style.transform = `translate(calc(-50% + ${gamma/4}px), calc(-50% + ${beta/4}px))`;
                }
            }

            handleKeydown(e) {
                switch(e.key) {
                    case 'Escape':
                        this.closeViewer();
                        break;
                    case 'ArrowLeft':
                    case 'ArrowRight':
                        // Could implement image navigation in viewer
                        break;
                }
            }

            handleResize() {
                if (window.innerWidth <= 768) {
                    this.elements.cursor.classList.remove('active');
                } else {
                    this.elements.cursor.classList.add('active');
                }
            }

            handleVisibilityChange() {
                if (document.hidden) {
                    if (this.rafId) {
                        cancelAnimationFrame(this.rafId);
                        this.rafId = null;
                    }
                } else {
                    if (!this.rafId && !this.state.isLoading) {
                        this.startParallaxAnimation();
                    }
                }
            }

            handleGlobalError(e) {
                console.error('Global error:', e.error);
                this.showErrorMessage('Ein unerwarteter Fehler ist aufgetreten');
            }

            openViewer(src, alt = '') {
                this.elements.viewerImg.src = src;
                this.elements.viewerImg.alt = alt;
                this.elements.viewer.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Focus management for accessibility
                this.elements.viewer.focus();
            }

            closeViewer() {
                this.elements.viewer.classList.remove('active');
                document.body.style.overflow = 'hidden';
            }

            updateCTALink() {
                // Update with actual download link
                const downloadLink = "HIER_DEIN_DROPBOX_LINK"; // Replace with actual link
                this.elements.cta.href = downloadLink;
            }

            handleError(message, error) {
                console.error(message, error);
                this.state.hasError = true;
                this.showErrorMessage(message);
                
                // Hide loading screen if error occurs during loading
                if (this.state.isLoading) {
                    this.elements.loading.classList.add('hidden');
                    this.state.isLoading = false;
                }
            }

            showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            // Utility methods
            throttle(func, limit) {
                let lastFunc;
                let lastRan;
                return function() {
                    const context = this;
                    const args = arguments;
                    if (!lastRan) {
                        func.apply(context, args);
                        lastRan = Date.now();
                    } else {
                        clearTimeout(lastFunc);
                        lastFunc = setTimeout(function() {
                            if ((Date.now() - lastRan) >= limit) {
                                func.apply(context, args);
                                lastRan = Date.now();
                            }
                        }, limit - (Date.now() - lastRan));
                    }
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Global functions for backward compatibility
        function closeViewer() {
            window.gallery?.closeViewer();
        }

        // Initialize gallery when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                window.gallery = new FirmungGallery();
            });
        } else {
            window.gallery = new FirmungGallery();
        }
    </script>
</body>
</html>
